# Логика работы (old/main_old.ino)

## Общая архитектура

ESP32 работает как BLE-периферия с именем "Camera_Slider". Управление через BLE-характеристики с callback-ами. Статус отдаётся по notify каждые 100мс.

При старте загружается калибровка из NVS. Если есть — слайдер знает свой рабочий ход и центр.

## Состояния

Четыре булевых флага определяют поведение в loop():

| Флаг              | Что делает                                           |
|-------------------|------------------------------------------------------|
| isMoving          | Непрерывное движение вперёд/назад (ручной режим)     |
| isHoming          | Процедура калибровки (блокирующая)                   |
| isMovingToPosition| Движение к целевой позиции (пошагово в loop)         |
| isCalibrated      | Можно ли использовать позиционирование               |

Приоритет в loop(): homing > moveToPosition > ручное движение.

## Ручное движение (F/B/S)

- Команда F — DIR_PIN LOW, isMoving=true, каретка едет вперёд
- Команда B — DIR_PIN HIGH, isMoving=true, каретка едет назад
- Команда S — всё стоп (сбрасывает все три флага движения)

При каждом шаге обновляется currentPosition (+1 при DIR LOW, -1 при DIR HIGH).

При достижении концевика — reverseDirection(): смена направления + откат на 200 шагов. Движение продолжается.

## Процедура хоминга (H)

Блокирующая процедура в doHoming(), вызывается из loop():

1. Едем назад (DIR HIGH) до ENDSTOP_1
   - Если по пути встретили ENDSTOP_2 — ошибка, выход
2. Откат на 200 шагов вперёд, currentPosition = 0
3. Едем вперёд (DIR LOW) до ENDSTOP_2, считаем шаги
4. travelDistance = кол-во шагов, откат на 200 шагов назад
5. Вычисляем центр: centerPosition = travelDistance / 2
6. Едем к центру
7. Сохраняем в NVS: travelDistance, centerPosition, calibrated=true

Скорость хоминга: 300 мкс/шаг (быстрее стандартных 800).

## Движение к позиции

При записи в Position-характеристику:
- Позиция ограничивается диапазоном [0, travelDistance]
- Требуется калибровка (isCalibrated)
- moveToPosition() вызывается из loop(), один шаг за итерацию
- Остановка когда |stepsToGo| < 5

## Хранение (NVS)

Namespace: "stepper"

| Ключ       | Тип  | Описание                    |
|------------|------|-----------------------------|
| travel     | Long | Полный ход в шагах          |
| center     | Long | Центральная позиция в шагах |
| calibrated | Bool | Есть ли калибровка          |

Загрузка при старте (loadCalibration), сохранение после хоминга (saveCalibration).

## Скорость

Задаётся через BLE, 2 байта little-endian, в микросекундах между шагами.
Диапазон: 100–5000 мкс/шаг.
По умолчанию: 800 мкс/шаг.

## Ток мотора

Задаётся через BLE, 2 байта little-endian, в мА.
Диапазон: 200–1500 мА.
По умолчанию: 800 мА.
Применяется сразу: driver.rms_current(motorCurrent).

## Отключение BLE

При разрыве соединения — все движения останавливаются (isMoving, isHoming, isMovingToPosition = false).
