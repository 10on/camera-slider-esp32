# Camera Slider — System Specification (v1.1)

## 1. Назначение документа

Документ описывает системную архитектуру слайдера:
- управление мотором в real-time
- машину состояний
- работу ADXL345
- режимы сна и парковки
- обработку ошибок
- расширяемую конфигурацию, доступную через BLE и UI

Документ является основной спецификацией для прошивки.

---

## 2. Архитектура управления мотором

### 2.1. Real-time контур движения

- Генерация STEP осуществляется ТОЛЬКО аппаратным таймером ESP32
- Таймер является единственным источником шагов
- STEP/DIR не управляются из loop(), BLE или UI
- Все внешние события влияют на движение через атомарные флаги

Это гарантирует:
- равномерные шаги
- отсутствие рассинхрона
- независимость от BLE, OLED и I2C

---

### 2.2. Ускорение и замедление (Ramp)

Используется короткий линейный ramp:
- длительность: десятки миллисекунд
- применяется при старте и остановке
- не влияет на позиционирование

Ramp реализуется внутри логики таймера.

---

## 3. Машина состояний

### 3.1. Состояния

IDLE — мотор выключен  
MANUAL_MOVING — ручное движение  
MOVING_TO_POS — движение к позиции  
HOMING — калибровка  
PARKING — аварийная парковка  
ERROR — ошибка  
SLEEP — логический сон  

---

### 3.2. Приоритет

ERROR  
HOMING  
PARKING  
MOVING_TO_POS  
MANUAL_MOVING  
IDLE / SLEEP  

---

## 4. ADXL345 — безопасность

### 4.1. Назначение

ADXL345 используется исключительно для безопасности:
- детект самопроизвольного движения
- определение направления движения
- инициирование PARKING

Не используется для позиционирования или стабилизации.

---

### 4.2. Аварийная парковка

Условия:
- состояние IDLE или SLEEP
- мотор выключен
- нет активных команд

При детекте движения:
1. определяется направление
2. состояние → PARKING
3. движение к соответствующему концевику
4. при срабатывании концевика мотор выключается
5. состояние → IDLE или SLEEP

---

## 5. Режим сна

### 5.1. Вход в сон

После N минут бездействия:
- мотор обесточен
- экран выключен
- BLE может оставаться активным
- ADXL активен

---

### 5.2. Поведение в сне

#### Вертикально / под углом
- при начале движения → PARKING
- после парковки возврат в SLEEP

#### Горизонтально
- движения нет → остаёмся в SLEEP

Пробуждение:
- энкодер
- BLE
- (опционально) ADXL

---

## 6. Концевики

- Концевики опрашиваются асинхронно (через PCF8574)
- Опрос в loop(), не в ISR
- При срабатывании выставляется флаг stopRequested
- Таймер корректно останавливает движение

Запас хода после срабатывания учитывается.

---

## 7. Конфигурационные режимы движения

### 7.1. Режим реакции на концевик (Endstop Mode)

Настраиваемая логика, применимая:
- через BLE
- через UI

Режимы:

0 — STOP  
При срабатывании концевика:
- движение останавливается
- состояние → IDLE

1 — BOUNCE  
При срабатывании:
- движение останавливается
- направление меняется
- движение продолжается (отъезд от концевика)

2 — PARK  
При срабатывании:
- движение продолжается до уверенного упора
- мотор выключается
- состояние → IDLE / SLEEP

Режим является глобальной настройкой.

---

### 7.2. Режим окончания ручного движения

Определяет, что делать после MANUAL_MOVING без команды Stop:

- Stop at Endstop
- Reverse at Endstop
- Hold Position

---

## 8. Микрошаги

- Микрошаги — глобальная настройка
- Диапазон: любые разумные значения (1…256)
- Изменение микрошагов:
  - останавливает мотор
  - сбрасывает калибровку
  - требует нового HOMING

---

## 9. BLE Disconnect

При потере BLE во время движения:
- мотор останавливается
- состояние → ERROR
- errorCode = BLE_LOST

В IDLE и SLEEP игнорируется.

---

## 10. Статус устройства

### 10.1. Status v1
Без изменений.

### 10.2. Status v2
Добавляется:
- errorCode
- state

---

## 11. LED-индикация

- BLE подключён → горит
- BLE нет → медленно мигает
- движение без BLE → выключен
- ERROR → постоянный свет или быстрый мигание
