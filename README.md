# Camera Slider (ESP32 + TMC2209 + BLE)

Надёжный контроллер моторизованного слайдера на ESP32 с реальным‑временем генерацией шагов, калибровкой, UI на OLED, энкодером, BLE‑управлением и безопасной парковкой по данным ADXL345.

## Возможности
- Реальный таймер ESP32 генерирует STEP (ровные шаги, без влияния UI/BLE)
- Режимы: ручное движение, движение к позиции, хоминг, парковка, сон, ошибка
- Хоминг с определением полного хода и центра, сохранение в NVS
- Три режима реакции на концевики: STOP, BOUNCE, PARK
- BLE‑сервис: команды, установка скорости/позиции/тока, статус (notify)
- OLED 128x64: главный экран, меню, редакторы значений, индикация ошибок
- Энкодер: навигация по меню, быстрые правки параметров
- ADXL345: детект самопроизвольного движения и безопасная парковка
- Режим сна: выключение экрана и драйвера, пробуждение по энкодеру/BLE/движению

## Аппаратная схема (кратко)
- МК: ESP32
- Драйвер: TMC2209 (UART), R_SENSE 0.11Ω, микрошаги по умолчанию 1/32, StealthChop
- I2C (SDA=8, SCL=9): PCF8574 (0x20/0x21), SSD1306 OLED (0x3C), ADXL345 (0x53/0x1D)
- Концевики и энкодер — через PCF8574; есть fallback на GPIO
- Светодиод от PCF8574, паттерны зависят от состояния

Точное назначение пинов и адреса — см. `docs/01_hardware.md`.

## Директории и файлы
- `slider.ino` — точка входа, глобальное состояние, главный цикл
- `slider_01_config.ino` — конфиг, NVS load/save, калибровка
- `slider_02_hw.ino` — инициализация TMC2209, I2C, PCF8574, OLED, ADXL345
- `slider_03_motor.ino` — ISR таймера, STEP, линейный разгон/торможение
- `slider_04_state.ino` — машина состояний, приоритеты, обработка ошибок
- `slider_05_endstops.ino` — опрос PCF8574, концевики, энкодер
- `slider_06_homing.ino` — неблокирующий хоминг по фазам
- `slider_07_adxl.ino` — детект движения и парковка
- `slider_08_ble.ino` — BLE‑сервис, колбэки, статус notify
- `slider_09_led.ino` — индикация LED через PCF8574
- `slider_10_display.ino` — отрисовка экрана и экранов меню
- `slider_11_menu.ino` — обработка энкодера, навигация, редакторы
- `slider_12_sleep.ino` — сон/пробуждение
- `docs/` — схемы, протокол BLE, спецификации UI/системы
- `old/` — предыдущие прототипы, в т.ч. `old/main_old.ino`

## Сборка и прошивка
- Платформа: Arduino IDE (ESP32 Arduino core) или PlatformIO
- Плата: ESP32 Dev Module (или соответствующий модуль ESP32)
- Откройте `slider.ino`, убедитесь, что все `.ino` файлы в одной папке проекта
- Библиотеки:
  - TMCStepper
  - Adafruit GFX Library
  - Adafruit SSD1306
  - ESP32 BLE Arduino (BLEDevice)
  - PCF8574
  - Preferences (в составе ESP32 core)
- Подключение UART к TMC2209: используется `HardwareSerial(1)` (TX=4, RX=5), 115200 бод

## Первичный запуск
1. Соберите аппаратно согласно `docs/01_hardware.md`
2. Залейте прошивку и подайте питание
3. Выполните хоминг (меню или BLE команда `H`) — сохранится ход и центр
4. Проверьте реакции на концевики, направление, микрошаги
5. При необходимости отредактируйте параметры в меню: скорость, ток, микрошаги, режим концевиков, таймаут сна, чувствительность ADXL

## Управление с устройства (OLED + энкодер)
- Главный экран: состояние, позиция (в % при калибровке или шаги), скорость, концевики, BLE
- Кнопка энкодера — вход в меню
- Меню: Manual Move, Go to Position, Calibration, Settings
- Редакторы значений: поворот — изменение, нажать — сохранить, долгий — отмена
- Хоминг: неблокирующий, прогресс и статусы фаз на экране

Подробности UI/меню: `docs/05_ui_menu(1).md`.

## BLE протокол
- Имя устройства: Camera_Slider
- Сервис: `4fafc201-1fb5-459e-8fcc-c5c9c331914b`
- Характеристики:
  - Command (WRITE) `beb5483e-36e1-4688-b7f5-ea07361b26a8`
    - 1 байт: `F` — вперёд, `B` — назад, `S` — стоп, `H` — хоминг, `R` — сброс ошибки
  - Speed (WRITE) `d8de624e-140f-4a22-8594-e2216b84a5f2`
    - 2 байта, uint16 LE — мкс/шаг (100..5000)
  - Position (WRITE) `a1b2c3d4-e5f6-4789-a012-3456789abcde`
    - 4 байта, int32 LE — целевая позиция в шагах (требуется калибровка)
  - Current (WRITE) `f1e2d3c4-b5a6-4978-9012-3456789abcde`
    - 2 байта, uint16 LE — ток мотора в мА (200..1500)
  - Status (READ/NOTIFY) `1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e`
    - 11 байт (v2):
      - [0..3] `currentPosition` int32 LE
      - [4] флаги: бит0 E1, бит1 E2, бит2 HOMING, бит3 CAL, бит4 GO_TO, бит5 MOVING, бит6 PARK
      - [5..8] `travelDistance` int32 LE
      - [9] `state` (enum)
      - [10] `errorCode`

Подробности и формат v1: `docs/03_ble_protocol.md`.

## Поведение и безопасность
- Реальный‑временной контур шагов — только аппаратный таймер; UI/BLE не мешают шагам
- При потерe BLE во время движения — остановка и `STATE_ERROR`
- ADXL345: в IDLE/SLEEP детектирует самодвижение и запускает парковку к ближайшему концевику
- Режимы концевиков (глобальная настройка): STOP, BOUNCE, PARK
- Сон: по таймауту в IDLE — выключение OLED и драйвера, пробуждение по энкодеру/BLE/движению

Детали архитектуры: `docs/04_system(2).md`.

## Настройки (NVS)
Сохраняются ключевые параметры: скорость, ток, микрошаги, ramp, режим концевиков, таймаут сна, чувствительность ADXL, калибровка (ход/центр). Реализация — `slider_01_config.ino`.

## Полезные советы
- Изменение микрошагов сбрасывает калибровку — требуется новый хоминг
- Для PCF8574 используйте полноценную запись байта (`write8`), чтобы не сбрасывать pull‑up на входах
- Ток подбирайте с запасом, но без перегрева двигателя/драйвера

## FAQ / открытые вопросы
Некоторые решения зафиксированы в `docs/06_questions.md` (ramp по умолчанию, скорость хоминга, формат Status v2 и др.).

## Лицензия
Не указана. Если нужно — добавьте файл LICENSE и обновите раздел.

